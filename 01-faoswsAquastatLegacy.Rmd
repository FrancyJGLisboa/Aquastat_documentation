# **The faoswsAquastatLegacy module** {#AquastatLegacy}

## **Aim**
According to the technical unit, there is a set of AQUASTAT variables that should have the same value over time. These variables are collectivelly known as Long-term average variables. However, it was observed that, for an unidentified reason, some of these variables have wrong values in the old AQUATSAT Working System and these errors persisted after the migration from the old system into SWS **aquastat_legacy** dataset.  Therefore, the **faoswsAquastatLegacy** module has the task of correcting these wrong values.

### **Identify LTAs**

The very first thing the module needs to do is to identify the LTAs in the **aquastat_legacy** dataset migrated by CIO - SWS. To identify the LTAs, the **faoswsAquastatLegacy** module uses the SWS **aquastat_reference** data table. This data table has a binary variable called **'lta'** which takes value **1** for the LTA variables/indicators and **0** for non-LTAs. The table below describes the LTAs in the SWS **aquastat_reference** data table.

<br>
<br>
```{r lta, width='100%', echo=FALSE, message=FALSE}
require(data.table)
require(kableExtra)
d = data.table::fread("tables/aquastat_meta_FL_sources.csv")
d = d[lta == 1L, .(element_code, element_name)]
knitr::kable(d,   
             caption = paste("Long-term average variables in AQUASTAT."),
             booktabs = TRUE) %>%
  kableExtra::kable_styling(font_size = 12)
```

### **Calculations before**

An aspect important of the correction of LTAs in the legacy data is that for LTAs that are also indicators, the right values only show up **AFTER** the calculations. Therefore, the module used the SWS **calculation_rule** data table to make the right values to come out.


```{r calcs, width='100%', echo=FALSE, message=FALSE}
require(data.table)
require(kableExtra)
d = data.table::fread("tables/calculation_rule.csv")
d = d[,.(calculation_rule, indicator_name, component_name)]
knitr::kable(d,   
             escape = TRUE,
             table.attr='class="table-fixed-header"',
             caption = paste("Calculation rules in AQUASTAT."),
             booktabs = TRUE) %>%
  kableExtra::kable_styling(font_size = 12)
```

<br>
<br>

### **Corrections**
With the emergence of right LTA values, the module corrects the LTAs by equating their observed values in each geographicAreaM49 - aquastatElement combination.



## **Workflow**
```{r fig1, echo=FALSE, out.width='100%', out.width='100%', fig.cap='Workflow of the faoswsAquastatLegacy module.'}
library(DiagrammeR)
DiagrammeR::grViz("digraph {

graph [layout = dot, rankdir = LR]

# define the global styles of the nodes. We can override these in box if we wish
node [shape = rectangle, style = filled, fillcolor = Linen]

# Inputs
Input [label = 'Dataset: \n SWS aquastat_legacy \n coming from the \n old AQUASTAT Working System', shape = folder, fillcolor = Beige]

# data tables
refer [label = 'Data table: \n SWS aquastat_reference data table', shape = folder, fillcolor = LightGrey]
calc [label = 'Data table: \n SWS calculation_rule data table', shape = folder, fillcolor = LightGrey]

# processing
Processing [label = 'Processing: \n 1. Read in SWS aquastat_legacy dataset \n 2. Calculation \n using calculation_rule data table, \n 2. Equate the right LTA values \n in each geographicAreaM49 - aquastatElement combination ', fillcolor = LightBlue]

# Output
Output [label = 'Dataset: \n aquastat_legacy dataset', shape = folder, fillcolor = Beige]

#Save
Save [label = 'Database: \n aquastat_legacy_corr dataset \n saved in the SWS', shape = folder, fillcolor = Beige]


# Flow
# edge definitions with the node IDs
{Input} -> Processing  -> Output -> Save
{refer, calc} -> Processing
}")

```

<br>
<br>

## **Running the module**

1. Log in the SWS;

2. Click on **New Query**;

```{r  newquery, echo=FALSE, out.width="100%"}
knitr::include_graphics("images/newquery.jpg")
```  

3. Select **AQUASTAT domain** and **aquastat_legacy_corr dataset**;

4. Select whatever country, measured element, and timePointYears;

```{block , type='rmdnote'}

The **faoswsAquastatAquastatLegacy** corrects the WHOLE **aquastat_legacy** dataset which means that the user's selections during this step are irrelevant for the module's output. 

```

5. Run the query;

6. Click on **Run plugin** on the top-right.

7. Select the **faoswsAquastatExternal** module and click on **Run plugin**;

```{r  runplugin, echo=FALSE, out.width="100%", fig.cap='Select faoswsAquastatLegacy module'}
knitr::include_graphics("images/plugin.jpg")
```  

8. Wait for the results to appear in the session;


9. Click on **Save to dataset** after validation.

<br>
<br>


## **Did the module..**

### correct values of Long-Term Average variables ?

```{r tab13, echo=FALSE, message=FALSE}
require(dplyr)
require(data.table)
require(kableExtra)
d = data.table::fread("tables/daf4157.csv")
knitr::kable(d,   
             caption = paste("An example of LTA correction by the module."),
             booktabs = TRUE) %>%
  kableExtra::kable_styling(font_size = 12)
```

## **Output feeds...**

The corrected version of the **aquasat_legacy** dataset output by the **faoswsAquastatLegacy** module is the **aquastat_legacy_corr** dataset. This dataset serves as an input of the **faoswsAquastatUpdate**.

<br>
<br>

```{block , type='rmdimportant'}

The **aquastat_legacy_corr** keeps the same dimension  names as the legacy dataset: **geographicAreaM49**, **aquastatElement**, **timePointYears**, and **flagAquastat**. 

The change of aquastatElement to measuredElement (SWS compliant) as well as the flag conversion from flagAquast to flagObaservationStatus are tasked to the faoswsAquastatUpdate module.


```


